<!doctype html>
<html>
  <head>
    <title>o2r Informer</title>
    <style>
    </style>
  </head>
  <body>
    <pre id="jobid" style="border: 1px solid blue;"></pre>
    <pre id="status" style="border: 1px solid black;"></pre>
    <pre id="log" style="border: 1px solid black;"></pre>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <script>
      // Setup socket.io to connect to the server and the namespace '/api/v1/logs/job'.
      var socket = io('http://localhost:8082/api/v1/logs/job');
      socket.on('connect', function(data) {
        console.log('connected!');
      });


      function update(event) {
        // This will hold the Job ID the data relates to.
        document.getElementById("jobid").innerHTML = event["id"];
        // Only the changed fields will be transmitted in a event, so check for each. For now, the data can only be accessed by string-keys,
        // because it is not a "real" object: { "steps.image_execute.status" : "foobar" } vs. { steps: { image_execute: { status : "foobar" } } }.
        if(event["steps.image_execute.status"] !== undefined) {
          document.getElementById("status").innerHTML = event["steps.image_execute.status"];
          switch (event["steps.image_execute.status"]) {
            case "queued":
              document.getElementById("log").style.backgroundColor = "#f0f0f0";
              break;
            case "running":
              document.getElementById("log").style.backgroundColor = "#ffffdd";
              break;
            case "success":
              document.getElementById("log").style.backgroundColor = "#ddffdd";
              break;
            case "failure":
              document.getElementById("log").style.backgroundColor = "#ffdddd";
              break;
            default:
              break;
          }
        }
        if(event["steps.image_execute.text"] !== undefined) {
          document.getElementById("log").innerHTML = event["steps.image_execute.text"];
          window.scrollTo(0,document.body.scrollHeight);
        }
      }

      // the server will emit "document" and "set" events for now. Later on these will be collapsed to one event.
      // a event will then contain the new information which is processed in update()
      socket.on("document", update);
      socket.on("set", update);
    </script>
  </body>
</html>
